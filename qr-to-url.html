<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>QR â†’ URL | MÃ©mento IA ENSOSP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="style.css">

  <!-- Libs QR + Compression -->
  <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>
  <script type="module">
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";
    window.QrScanner = QrScanner;
  </script>
</head>

<body>

  <nav class="tabs">
    <a href="index.html" class="tab">ğŸ  Accueil</a>
    <a href="scan.html" class="tab">ğŸ“· Lecture QR</a>
    <a href="create.html" class="tab">ğŸ“ CrÃ©ation</a>
    <a class="tab active">ğŸ”— QR â†’ URL</a>
  </nav>

  <main>
    <h1 class="page-title">Convertir QR Code â†’ URL cliquable</h1>

    <div style="background:#e7f3ff;border-left:4px solid #001F8F;padding:12px 15px;margin-bottom:20px;border-radius:8px;">
      <strong style="display:block;margin-bottom:5px;color:#001F8F;">ğŸ’¡ Ã€ quoi Ã§a sert ?</strong>
      Cette page vous permet de transformer un QR Code dÃ©jÃ  crÃ©Ã© en lien cliquable pour vos PDF.
      Importez simplement l'image du QR Code et vous obtiendrez l'URL correspondante.
    </div>

    <!-- IMPORT QR -->
    <section class="card">
      <h2>1. Importer votre QR Code existant</h2>

      <div style="margin-bottom:15px;">
        <label style="display:block;margin-bottom:10px;font-weight:600;">
          ğŸ“ SÃ©lectionner l'image du QR Code
        </label>
        <input type="file" id="qrFileInput" accept="image/*" style="width:100%;">
      </div>

      <div id="previewContainer" style="display:none;margin-top:15px;text-align:center;">
        <p style="font-weight:600;margin-bottom:10px;">AperÃ§u :</p>
        <img id="qrPreview" style="max-width:300px;border:2px solid #ccc;border-radius:8px;">
      </div>
    </section>

    <!-- RÃ‰SULTAT -->
    <section class="card" id="resultSection" style="display:none;">
      <h2>2. URL gÃ©nÃ©rÃ©e</h2>

      <div style="background:#d4edda;border-left:4px solid #28a745;padding:12px 15px;margin-bottom:15px;border-radius:8px;">
        <strong style="display:block;margin-bottom:5px;color:#155724;">âœ… QR Code dÃ©codÃ© avec succÃ¨s !</strong>
        Utilisez l'URL ci-dessous comme lien hypertexte dans votre PDF.
      </div>

      <div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #dee2e6;margin-bottom:15px;">
        <input 
          type="text" 
          id="urlResult" 
          readonly 
          style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:13px;font-family:monospace;background:white;">
      </div>

      <button id="btnCopyUrl" class="btn">
        ğŸ”— Copier le lien
      </button>

      <div style="margin-top:20px;padding:12px;background:#fff3e6;border-left:4px solid #ff9f1c;border-radius:8px;">
        <strong style="display:block;margin-bottom:8px;color:#856404;">ğŸ“– Comment l'utiliser dans Word/PDF ?</strong>
        <ol style="margin:0;padding-left:20px;font-size:13px;color:#856404;line-height:1.6;">
          <li>InsÃ©rez l'image du QR Code dans votre document</li>
          <li>SÃ©lectionnez l'image â†’ Clic droit â†’ Lien hypertexte</li>
          <li>Collez l'URL copiÃ©e</li>
          <li>Exportez en PDF â†’ Le QR devient cliquable !</li>
        </ol>
      </div>
    </section>

  </main>

  <footer>
    Â© ENSOSP â€“ Cne E. Fischer â€“ Cdt A. Tirelle â€“ V0.10
  </footer>

  <script type="module">
    import { generateFicheUrl } from "./src/core/urlEncoder.js";

    const fileInput = document.getElementById("qrFileInput");
    const previewContainer = document.getElementById("previewContainer");
    const qrPreview = document.getElementById("qrPreview");
    const resultSection = document.getElementById("resultSection");
    const urlResult = document.getElementById("urlResult");
    const btnCopyUrl = document.getElementById("btnCopyUrl");

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        // Afficher aperÃ§u
        const reader = new FileReader();
        reader.onload = (ev) => {
          qrPreview.src = ev.target.result;
          previewContainer.style.display = "block";
        };
        reader.readAsDataURL(file);

        // Scanner le QR
        const QrScanner = window.QrScanner;
        const result = await QrScanner.scanImage(file, { returnDetailedScanResult: true });
        
        console.log("ğŸ“· QR dÃ©codÃ© :", result.data);

        // Le QR contient dÃ©jÃ  le JSON compressÃ©
        const compressedData = result.data;

        // GÃ©nÃ©rer l'URL
        const baseUrl = window.location.origin + window.location.pathname.replace('qr-to-url.html', '');
        const ficheUrl = `${baseUrl}scan.html?fiche=${encodeURIComponent(compressedData)}`;

        // Afficher
        urlResult.value = ficheUrl;
        resultSection.style.display = "block";

        console.log("ğŸ”— URL gÃ©nÃ©rÃ©e :", ficheUrl);

      } catch (error) {
        console.error("âŒ Erreur lecture QR :", error);
        alert("âš ï¸ Impossible de lire ce QR Code. VÃ©rifiez que l'image est nette et complÃ¨te.");
        previewContainer.style.display = "none";
        resultSection.style.display = "none";
      }
    });

    // Copier URL
    btnCopyUrl.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(urlResult.value);
        btnCopyUrl.textContent = "âœ… Lien copiÃ© !";
        btnCopyUrl.style.background = "#28a745";
        
        setTimeout(() => {
          btnCopyUrl.textContent = "ğŸ”— Copier le lien";
          btnCopyUrl.style.background = "";
        }, 2000);
      } catch (err) {
        console.error("âŒ Erreur copie :", err);
        alert("âŒ Impossible de copier. Veuillez copier manuellement.");
      }
    });
  </script>

</body>
</html>
